<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aplikasi Keuangan</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f5f7fa; margin:0; padding:0; }
    .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h2,h3 { color:#333; margin-bottom:10px; }
    button { background:#4f46e5; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
    button:hover { background:#4338ca; }
    input, select { padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:6px; width:100%; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th { background:#4f46e5; color:white; padding:10px; text-align:left; }
    td { border-bottom:1px solid #ddd; padding:8px; }
    tr:hover { background:#f9fafb; }
    .summary { display:flex; gap:20px; margin:10px 0; }
    .card { flex:1; padding:15px; border-radius:8px; color:white; text-align:center; }
    .income { background:#16a34a; }
    .expense { background:#dc2626; }
    .balance { background:#2563eb; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Aplikasi Keuangan</h2>

    <!-- Login -->
    <div id="loginDiv">
      <h3></h3>
      <input id="username" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button onclick="login()">Login</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <h3>Selamat datang, <span id="userLabel"></span></h3>
      <button onclick="logout()">Logout</button>

      <!-- Ringkasan -->
      <div class="summary">
        <div class="card income">
          <h4>Pemasukan</h4>
          <p id="sumIncome">0</p>
        </div>
        <div class="card expense">
          <h4>Pengeluaran</h4>
          <p id="sumExpense">0</p>
        </div>
        <div class="card balance">
          <h4>Saldo</h4>
          <p id="sumBalance">0</p>
        </div>
      </div>

      <!-- Tambah Transaksi -->
      <h3>Tambah Transaksi</h3>
      <input id="nominal" type="number" placeholder="Nominal" />
      <input id="keterangan" placeholder="Keterangan" />
      <input id="bukti" type="file" />
      <button onclick="addItem()">Tambah</button>

      <!-- Data Tabel -->
      <h3>Data Transaksi</h3>
      <table>
        <thead>
          <tr>
            <th>Nominal</th>
            <th>Keterangan</th>
            <th>Bukti</th>
            <th>Tanggal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentUser = null;

    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (data.success) {
        currentUser = data.user;
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("userLabel").innerText = currentUser.username;
        loadItems();
        loadSummary();
      } else {
        alert("Login gagal!");
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById("loginDiv").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
    }

    async function addItem() {
      const nominal = document.getElementById("nominal").value;
      const keterangan = document.getElementById("keterangan").value;
      const buktiFile = document.getElementById("bukti").files[0];

      let buktiUrl = "";
      if (buktiFile) {
        const formData = new FormData();
        formData.append("file", buktiFile);
        const upload = await fetch("/upload", { method: "POST", body: formData });
        const result = await upload.json();
        if (result.success) buktiUrl = result.link;
      }

      await fetch("/items", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: currentUser.id, nominal, keterangan, buktiUrl })
      });

      document.getElementById("nominal").value = "";
      document.getElementById("keterangan").value = "";
      document.getElementById("bukti").value = "";

      loadItems();
      loadSummary();
    }

    async function loadItems() {
      const res = await fetch(`/items/${currentUser.id}?role=${currentUser.role}`);
      const items = await res.json();
      const tbody = document.getElementById("itemsBody");
      tbody.innerHTML = "";

      items.forEach(i => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i.nominal}</td>
          <td>${i.keterangan}</td>
          <td>${i.buktiUrl ? `<a href="${i.buktiUrl}" target="_blank">Lihat</a>` : "-"}</td>
          <td>${new Date(i.createdAt).toLocaleString()}</td>
          <td><button onclick="deleteItem(${i.id})">Hapus</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteItem(id) {
      await fetch("/items/" + id, { method: "DELETE" });
      loadItems();
      loadSummary();
    }

    async function loadSummary() {
      const res = await fetch(`/summary/${currentUser.id}?role=${currentUser.role}`);
      const s = await res.json();
      document.getElementById("sumIncome").innerText = s.income || 0;
      document.getElementById("sumExpense").innerText = s.expense || 0;
      document.getElementById("sumBalance").innerText = s.balance || 0;
    }
  </script>
</body>
</html>
