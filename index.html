<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi Pencatatan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Loader overlay */
    #loadingOverlay {
      transition: opacity 0.3s ease-in-out;
    }
    /* Pagination */
    #pagination button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    #pagination button.active {
      background-color: #2563eb;
      color: white;
      font-weight: bold;
    }
    #pagination button:hover {
      background-color: #e5e7eb;
    }
    /* Modal animasi */
    #globalModal {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #globalModal.show {
      opacity: 1;
    }
    #globalModal .bg-white {
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s ease;
    }
    #globalModal.show .bg-white {
      transform: scale(1);
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Loader -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="text-white text-xl">Loading...</div>
  </div>

  <!-- Container utama -->
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">ðŸ“’ Aplikasi Pencatatan</h1>

    <!-- Login Section -->
    <div id="loginSection" class="max-w-sm mx-auto bg-white rounded-lg shadow p-4 mb-4">
      <h2 class="text-lg font-bold mb-2">Login</h2>
      <input id="usernameInput" type="text" placeholder="Masukkan username"
        class="border rounded w-full p-2 mb-2" />
      <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
    </div>

    <!-- App Section -->
    <div id="appSection" class="hidden">
      <!-- Form tambah item -->
      <div class="bg-white rounded-lg shadow p-4 mb-4">
        <h2 class="text-lg font-bold mb-2">Tambah Data</h2>
        <input id="namaInput" type="text" placeholder="Nama"
          class="border rounded w-full p-2 mb-2" />
        <input id="nominalInput" type="number" placeholder="Nominal"
          class="border rounded w-full p-2 mb-2" />
        <textarea id="keteranganInput" placeholder="Keterangan"
          class="border rounded w-full p-2 mb-2"></textarea>
        <input id="tanggalInput" type="date"
          class="border rounded w-full p-2 mb-2" />
        <input id="fileInput" type="file" accept="image/*"
          class="border rounded w-full p-2 mb-2" />
        <button onclick="addItem()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Tambah</button>
      </div>

      <!-- Filter & Search -->
      <div class="bg-white rounded-lg shadow p-4 mb-4 flex flex-wrap gap-2 items-center">
        <input id="searchInput" type="text" placeholder="Cari data..."
          class="border rounded p-2 flex-1" oninput="loadItems()" />
        <select id="sortSelect" onchange="loadItems()" class="border rounded p-2">
          <option value="tanggal">Tanggal</option>
          <option value="nominal">Nominal</option>
          <option value="nama">Nama</option>
        </select>
        <select id="orderSelect" onchange="loadItems()" class="border rounded p-2">
          <option value="desc">Desc</option>
          <option value="asc">Asc</option>
        </select>
        <select id="rangeSelect" onchange="loadItems()" class="border rounded p-2">
          <option value="all">Semua</option>
          <option value="today">Hari ini</option>
          <option value="week">Minggu ini</option>
          <option value="month">Bulan ini</option>
        </select>
      </div>

      <!-- Ringkasan -->
      <div id="summaryBox" class="bg-white rounded-lg shadow p-4 mb-4"></div>

      <!-- Tabel Data -->
      <div class="bg-white rounded-lg shadow overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">Nama</th>
              <th class="px-4 py-2">Nominal</th>
              <th class="px-4 py-2">Tanggal</th>
              <th class="px-4 py-2">User</th>
              <th class="px-4 py-2">Aksi</th>
            </tr>
          </thead>
          <tbody id="itemsTable"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="flex gap-2 mt-4"></div>
    </div>
  </div>

  <!-- GLOBAL MODAL -->
  <div id="globalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <div id="modalContent"></div>
      <div id="modalActions" class="mt-4 flex justify-end gap-2"></div>
      <button onclick="closeModal()" 
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">âœ•</button>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    let currentUser = null;
    let currentPage = 1;
    let pageLimit = 5;

    // Loader
    function showLoading() { document.getElementById("loadingOverlay").classList.remove("hidden"); }
    function hideLoading() { document.getElementById("loadingOverlay").classList.add("hidden"); }

    // Modal
    function openModal(content, actions = "") {
      const modal = document.getElementById("globalModal");
      document.getElementById("modalContent").innerHTML = content;
      document.getElementById("modalActions").innerHTML = actions;
      modal.classList.remove("hidden");
      setTimeout(() => modal.classList.add("show"), 10);
    }
    function closeModal() {
      const modal = document.getElementById("globalModal");
      modal.classList.remove("show");
      setTimeout(() => modal.classList.add("hidden"), 300);
    }
    // close modal jika klik luar
    document.getElementById("globalModal").addEventListener("click", (e) => {
      if (e.target.id === "globalModal") closeModal();
    });
    // Tutup modal pakai ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // Login
    async function login() {
      const username = document.getElementById("usernameInput").value.trim();
      if (!username) return alert("Masukkan username!");
      try {
        showLoading();
        const res = await fetch(API_URL + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });
        hideLoading();
        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Login gagal");
        }
        const data = await res.json();
        currentUser = data.user;
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appSection").classList.remove("hidden");
        loadItems();
      } catch (err) {
        hideLoading();
        alert("Error: " + err.message);
      }
    }

    // Tambah item
    async function addItem() {
      const nama = document.getElementById("namaInput").value.trim();
      const nominal = document.getElementById("nominalInput").value.trim();
      const keterangan = document.getElementById("keteranganInput").value.trim();
      const tanggal = document.getElementById("tanggalInput").value;
      const file = document.getElementById("fileInput").files[0];

      if (!nama || !nominal) {
        return alert("Nama & nominal wajib diisi!");
      }

      let uploadRes = null;
      if (file) {
        const formData = new FormData();
        formData.append("file", file);
        showLoading();
        const res = await fetch(API_URL + "/upload", {
          method: "POST",
          headers: { "x-username": currentUser.username },
          body: formData
        });
        hideLoading();
        uploadRes = await res.json();
        if (!uploadRes.success) {
          return alert("Upload gagal!");
        }
      }

      const body = {
        nama,
        nominal,
        keterangan,
        tanggal,
        photoUrl: uploadRes ? uploadRes.link : null,
        publicId: uploadRes ? uploadRes.id : null
      };

      try {
        showLoading();
        const res = await fetch(API_URL + "/items", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-username": currentUser.username
          },
          body: JSON.stringify(body)
        });
        hideLoading();
        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Gagal tambah item");
        }
        document.getElementById("namaInput").value = "";
        document.getElementById("nominalInput").value = "";
        document.getElementById("keteranganInput").value = "";
        document.getElementById("tanggalInput").value = "";
        document.getElementById("fileInput").value = "";
        loadItems();
      } catch (err) {
        hideLoading();
        alert("Error: " + err.message);
      }
    }
    // Load items
    async function loadItems(page = 1) {
      currentPage = page;
      const search = document.getElementById("searchInput").value;
      const sort = document.getElementById("sortSelect").value;
      const order = document.getElementById("orderSelect").value;
      const range = document.getElementById("rangeSelect").value;

      try {
        showLoading();
        const url = new URL(API_URL + "/items");
        url.searchParams.set("page", currentPage);
        url.searchParams.set("limit", pageLimit);
        if (search) url.searchParams.set("search", search);
        if (sort) url.searchParams.set("sort", sort);
        if (order) url.searchParams.set("order", order);
        if (range) url.searchParams.set("range", range);

        const res = await fetch(url, { headers: { "x-username": currentUser.username } });
        hideLoading();
        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Gagal ambil data");
        }
        const { data, total, summary } = await res.json();
        renderTable(data);
        renderPagination(total);
        renderSummary(summary);
      } catch (err) {
        hideLoading();
        alert("Error: " + err.message);
      }
    }

    // Render tabel
    function renderTable(items) {
      const tbody = document.getElementById("itemsTable");
      tbody.innerHTML = "";
      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4">Tidak ada data</td></tr>`;
        return;
      }
      items.forEach(it => {
        const tr = document.createElement("tr");
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="px-4 py-2">${escapeHtml(it.nama)}</td>
          <td class="px-4 py-2">Rp ${it.nominal.toLocaleString()}</td>
          <td class="px-4 py-2">${escapeHtml(it.tanggal)}</td>
          <td class="px-4 py-2">${escapeHtml(it.user)}</td>
          <td class="px-4 py-2 flex gap-2">
            <button class="text-blue-600" onclick="viewDetail(${it.id})">Lihat</button>
            <button class="text-yellow-600" onclick="editItem(${it.id})">Edit</button>
            <button class="text-red-600" onclick="deleteItem(${it.id})">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render pagination
    function renderPagination(total) {
      const totalPages = Math.ceil(total / pageLimit);
      const container = document.getElementById("pagination");
      container.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = i === currentPage ? "active" : "";
        btn.onclick = () => loadItems(i);
        container.appendChild(btn);
      }
    }

    // Render summary
    function renderSummary(summary) {
      const box = document.getElementById("summaryBox");
      if (!summary) return (box.innerHTML = "");
      let html = `
        <p><b>Total Data:</b> ${summary.totalItems}</p>
        <p><b>Total Nominal:</b> Rp ${summary.totalNominal.toLocaleString()}</p>
      `;
      if (summary.breakdown) {
        html += `<h3 class="mt-2 font-bold">Per User:</h3>`;
        for (const [user, val] of Object.entries(summary.breakdown)) {
          html += `<p>${user}: ${val.totalItems} item, Rp ${val.totalNominal.toLocaleString()}</p>`;
        }
      }
      box.innerHTML = html;
    }

    // Detail modal
    function viewDetail(id) {
      fetch(API_URL + "/items", { headers: { "x-username": currentUser.username } })
        .then(res => res.json())
        .then(({ data }) => {
          const it = data.find(x => x.id === id);
          if (!it) return alert("Data tidak ditemukan");
          let content = `
            <h2 class="text-lg font-bold mb-2">Detail Item</h2>
            <p><b>Nama:</b> ${escapeHtml(it.nama)}</p>
            <p><b>Nominal:</b> Rp ${it.nominal.toLocaleString()}</p>
            <p><b>Keterangan:</b> ${escapeHtml(it.keterangan || "-")}</p>
            <p><b>Tanggal:</b> ${escapeHtml(it.tanggal)}</p>
            <p><b>User:</b> ${escapeHtml(it.user)}</p>
          `;
          if (it.photoUrl) {
            content += `<p class="mt-2"><a href="${it.photoUrl}" target="_blank" class="text-blue-600 underline">Lihat Bukti</a></p>`;
          }
          openModal(content, `<button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded">Tutup</button>`);
        });
    }

    // Edit item
    function editItem(id) {
      fetch(API_URL + "/items", { headers: { "x-username": currentUser.username } })
        .then(res => res.json())
        .then(({ data }) => {
          const it = data.find(x => x.id === id);
          if (!it) return alert("Data tidak ditemukan");

          const content = `
            <h2 class="text-lg font-bold mb-2">Edit Item</h2>
            <input id="editNama" value="${escapeHtml(it.nama)}" class="border rounded w-full p-2 mb-2" />
            <input id="editNominal" type="number" value="${it.nominal}" class="border rounded w-full p-2 mb-2" />
            <textarea id="editKet" class="border rounded w-full p-2 mb-2">${escapeHtml(it.keterangan || "")}</textarea>
            <input id="editTanggal" type="date" value="${escapeHtml(it.tanggal)}" class="border rounded w-full p-2 mb-2" />
          `;

          const actions = `
            <button onclick="closeModal()" class="px-4 py-2 rounded bg-gray-400 text-white">Batal</button>
            <button onclick="saveEdit(${id})" class="px-4 py-2 rounded bg-green-600 text-white">Simpan</button>
          `;

          openModal(content, actions);
        });
    }

    async function saveEdit(id) {
      const body = {
        nama: document.getElementById("editNama").value.trim(),
        nominal: document.getElementById("editNominal").value.trim(),
        keterangan: document.getElementById("editKet").value.trim(),
        tanggal: document.getElementById("editTanggal").value
      };
      try {
        showLoading();
        const res = await fetch(API_URL + "/items/" + id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "x-username": currentUser.username
          },
          body: JSON.stringify(body)
        });
        hideLoading();
        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Update gagal");
        }
        closeModal();
        loadItems(currentPage);
      } catch (err) {
        hideLoading();
        alert("Error: " + err.message);
      }
    }

    // Delete item
    function deleteItem(id) {
      const content = `<p>Yakin mau hapus item ini?</p>`;
      const actions = `
        <button onclick="closeModal()" class="px-4 py-2 rounded bg-gray-400 text-white">Batal</button>
        <button onclick="confirmDelete(${id})" class="px-4 py-2 rounded bg-red-600 text-white">Hapus</button>
      `;
      openModal(content, actions);
    }

    async function confirmDelete(id) {
      try {
        showLoading();
        const res = await fetch(API_URL + "/items/" + id, {
          method: "DELETE",
          headers: { "x-username": currentUser.username }
        });
        hideLoading();
        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Hapus gagal");
        }
        closeModal();
        loadItems(currentPage);
      } catch (err) {
        hideLoading();
        alert("Error: " + err.message);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
