<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keuangan App</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <div id="loginForm">
    <input id="username" placeholder="username" />
    <input id="password" type="password" placeholder="password" />
    <button onclick="login()">Login</button>
  </div>

  <div id="app" class="hidden">
    <h2 id="welcome"></h2>
    <button onclick="logout()">Logout</button>

    <h3>Ringkasan</h3>
    <p>Pemasukan: <span id="pemasukan">0</span></p>
    <p>Pengeluaran: <span id="pengeluaran">0</span></p>
    <p>Saldo: <span id="saldo">0</span></p>
    <button onclick="exportCSV()">Export CSV</button>

    <h3>Tambah Transaksi</h3>
    <form id="itemForm">
      <input type="number" id="nominal" placeholder="Nominal (gunakan - utk keluar)" required /><br/>
      <input type="text" id="keterangan" placeholder="Keterangan" required /><br/>
      <input type="file" id="file" /><br/>
      <button type="submit">Simpan</button>
    </form>

    <h3>Data Transaksi</h3>
    <table id="itemsTable">
      <thead>
        <tr>
          <th>ID</th><th>Nominal</th><th>Keterangan</th><th>Bukti</th><th>Tanggal</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
let currentUser = null;

async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const res = await fetch("/login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({username, password})
  });
  const data = await res.json();
  if (res.ok) {
    currentUser = data;
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("welcome").innerText = `Halo, ${data.username} (${data.role})`;
    loadItems();
    loadSummary();
  } else {
    alert(data.error);
  }
}

function logout() {
  currentUser = null;
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("app").classList.add("hidden");
}

async function loadItems() {
  if (!currentUser) return;
  const res = await fetch(`/items/${currentUser.id}?role=${currentUser.role}`);
  const items = await res.json();
  const tbody = document.querySelector("#itemsTable tbody");
  tbody.innerHTML = "";
  items.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.id}</td>
      <td>${item.nominal}</td>
      <td>${item.keterangan}</td>
      <td>${item.buktiUrl ? `<a href="${item.buktiUrl}" target="_blank">Bukti</a>` : "-"}</td>
      <td>${new Date(item.createdAt).toLocaleString()}</td>
      <td><button onclick="deleteItem(${item.id})">Hapus</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadSummary() {
  if (!currentUser) return;
  const res = await fetch(`/summary/${currentUser.id}?role=${currentUser.role}`);
  const s = await res.json();
  document.getElementById("pemasukan").innerText = s.pemasukan;
  document.getElementById("pengeluaran").innerText = s.pengeluaran;
  document.getElementById("saldo").innerText = s.saldo;
}

document.getElementById("itemForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser) return;
  const formData = new FormData();
  formData.append("userId", currentUser.id);
  formData.append("nominal", document.getElementById("nominal").value);
  formData.append("keterangan", document.getElementById("keterangan").value);
  const file = document.getElementById("file").files[0];
  if (file) formData.append("file", file);

  const res = await fetch("/items", { method: "POST", body: formData });
  if (res.ok) {
    document.getElementById("itemForm").reset();
    loadItems();
    loadSummary();
  } else {
    alert("Gagal simpan");
  }
});

async function deleteItem(id) {
  if (!confirm("Yakin hapus?")) return;
  const res = await fetch(`/items/${id}`, { method: "DELETE" });
  if (res.ok) {
    loadItems();
    loadSummary();
  }
}

function exportCSV() {
  if (!currentUser) return;
  window.location.href = `/export/${currentUser.id}?role=${currentUser.role}`;
}
</script>
</body>
</html>
