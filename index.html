<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Finance Apps</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- MODAL BASE -->
    <div id="modalContainer" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div id="modalContent" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg max-w-lg w-full p-6 relative">
        <button id="modalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">‚úñ</button>
        <div id="modalBody" class="text-sm text-gray-800 dark:text-gray-200">
          <!-- Konten detail transaksi akan dimasukkan via JS -->
        </div>
      </div>
    </div>

    <!-- ALERT BASE -->
    <div id="alertContainer" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-80 p-5 text-center">
        <p id="alertMessage" class="mb-4 text-gray-800 dark:text-gray-200">Pesan alert</p>
        <div class="flex justify-center gap-3">
          <button id="alertOk" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
          <button id="alertCancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500">Batal</button>
        </div>
      </div>
    </div>

    <!-- LOGIN SCREEN -->
    <main id="loginScreen" class="min-h-screen flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4 text-center">üîê Masuk</h2>
        <input id="userInput" class="w-full p-3 mb-3 rounded border dark:bg-gray-700" placeholder="username" />
        <input id="passInput" type="password" class="w-full p-3 mb-4 rounded border dark:bg-gray-700" placeholder="password" />
        <button id="btnLogin" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Masuk</button>
      </div>
    </main>

    <!-- DASHBOARD -->
    <div id="app" class="hidden">
      <!-- Navbar -->
      <nav class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h1 class="font-bold text-lg">üìä Finance</h1>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnExportExcel" class="px-3 py-2 bg-purple-600 text-white rounded">Export Excel</button>
          <button id="btnLogout" class="px-3 py-2 bg-red-500 text-white rounded">Logout</button>
        </div>
      </nav>

      <!-- Content -->
      <section class="max-w-5xl mx-auto p-6">

        <!-- Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow">
            <p class="text-sm text-gray-500">Pemasukan</p>
            <p id="totalIncome" class="text-xl font-bold text-green-600">Rp 0</p>
          </div>
          <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow">
            <p class="text-sm text-gray-500">Pengeluaran</p>
            <p id="totalExpense" class="text-xl font-bold text-red-600">Rp 0</p>
          </div>
          <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow">
            <p class="text-sm text-gray-500">Saldo</p>
            <p id="totalBalance" class="text-xl font-bold text-blue-600">Rp 0</p>
          </div>
        </div>

        <!-- Form Tambah Transaksi -->
        <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-lg max-w-3xl mx-auto mt-6 mb-10">
          <h2 class="text-xl font-semibold mb-4">Tambah Data Sayang ‚ù§Ô∏è</h2>
          <form id="itemForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="fieldNominal" type="text" inputmode="numeric"
              placeholder="Nominal (positif/pemasukan)"
              class="w-full h-11 px-3 rounded bg-gray-700 text-white placeholder-gray-400" />
            <input id="fieldKeterangan" type="text" placeholder="Keterangan"
              class="w-full h-11 px-3 rounded bg-gray-700 text-white placeholder-gray-400" />
            <input id="fieldTanggal" type="date"
            class="w-full h-11 px-3 rounded bg-gray-700 text-white" />
            <input id="fileInput" type="file" accept="image/*"
              class="md:col-span-2 w-full h-11 text-sm text-gray-300
                     file:mr-4 file:py-2 file:px-4
                     file:rounded-lg file:border-0
                     file:bg-blue-600 file:text-white
                     hover:file:bg-blue-700" />
            <div id="userSelectContainer" class="hidden md:col-span-1">
                <select id="userSelect" class="w-full h-11 px-3 rounded bg-gray-700 text-white">
                    <!-- Default manual fallback -->
                    <option value="">Pilih User</option>
                    <option value="ruslan">Ruslan</option>
                    <option value="fenita">Fenita</option>
                </select>
            </div>
            <button id="submitBtn" type="submit"
              class="md:col-span-1 w-full bg-green-600 hover:bg-green-500 py-2 rounded text-white font-semibold">
              Simpan
            </button>
          </form>
          <p id="uploadStatus" class="text-sm text-gray-400 mt-2"></p>
        </div>

        <!-- List Transaksi -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow max-w-5xl mx-auto mb-10">

        <!-- Search & Filters -->
        <div class="flex flex-col gap-3 mb-4">

            <!-- Baris 1: Search + Reset -->
            <div class="flex items-center gap-2">
                <input id="searchInput" type="text" placeholder="Cari transaksi..." 
                class="flex-1 p-2 border rounded dark:bg-gray-700" />
                <button id="btnReset" title="Reset filter"
                class="p-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                üîÑ
                </button>
            </div>

            <!-- Baris 2: Sort + Range -->
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-end">
                <select id="sortSelect" class="p-2 border rounded dark:bg-gray-700">
                <option value="date_desc">Tanggal Terbaru</option>
                <option value="date_asc">Tanggal Lama</option>
                <option value="nominal_desc">Nominal Terbesar</option>
                <option value="nominal_asc">Nominal Terkecil</option>
                </select>
                <select id="filterRange" class="p-2 border rounded dark:bg-gray-700">
                <option value="all">Semua</option>
                <option value="today">Hari ini</option>
                <option value="week">Minggu ini</option>
                <option value="month">Bulan ini</option>
                </select>
            </div>
        </div>

          <!-- Table Desktop -->
          <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full border-collapse">
                <thead id="tableHead" class="bg-gray-100 dark:bg-gray-700"></thead>
                <tbody id="tableBody" class="divide-y divide-gray-200 dark:divide-gray-600"></tbody>
            </table>
          </div>
          
          <!-- Cards Mobile -->
          <div id="cardList" class="md:hidden space-y-3 mt-4"></div>

          <!-- Pagination -->
          <div id="pagination" class="flex justify-center mt-6 space-x-2"></div>
        </div>

      </section>
    </div>

    <script>
        const API_URL = "https://balancing-wop-production.up.railway.app";
        const UPLOAD_ENDPOINT = API_URL + "/upload";
        const ITEMS_ENDPOINT = API_URL + "/items";

        const app = document.getElementById("app");
        const loadingOverlay = document.getElementById("loadingOverlay");

        // === MODAL / ALERT SYSTEM ===
        const modalContainer = document.getElementById("modalContainer");
        const modalBody = document.getElementById("modalBody");
        const modalClose = document.getElementById("modalClose");

        const alertContainer = document.getElementById("alertContainer");
        const alertMessage = document.getElementById("alertMessage");
        const alertOk = document.getElementById("alertOk");
        const alertCancel = document.getElementById("alertCancel");

        // === CACHE ITEM TERAKHIR DARI LIST (UNTUK DETAIL) ===
        let lastItemsCache = [];
        const itemsById = new Map();

        function showModal(html) {
        modalBody.innerHTML = html;
        modalContainer.classList.remove("hidden");
        }
        function closeModal() {
        modalContainer.classList.add("hidden");
        modalBody.innerHTML = "";
        }

        // === ALERT NOTIF (auto close) ===
        function showAlert(message, type = "info", timeout = 3000) {
        alertMessage.textContent = message;
        alertContainer.classList.remove("hidden");
        alertMessage.className =
            type === "error"
            ? "mb-4 text-red-600 dark:text-red-400"
            : "mb-4 text-green-600 dark:text-green-400";

        alertOk.style.display = "none";
        alertCancel.style.display = "none";
        setTimeout(() => hideAlert(), timeout);
        }
        function hideAlert() {
        alertContainer.classList.add("hidden");
        alertMessage.textContent = "";
        }

        // === ALERT CONFIRM (khusus delete) ===
        function showAlertConfirm(message, onOk, onCancel) {
        alertMessage.textContent = message;
        alertContainer.classList.remove("hidden");

        alertOk.style.display = "inline-block";
        alertCancel.style.display = "inline-block";

        alertOk.onclick = () => {
            hideAlert();
            if (onOk) onOk();
        };
        alertCancel.onclick = () => {
            hideAlert();
            if (onCancel) onCancel();
        };
        }

        // Close modal/alert on ESC + click luar
        document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            if (!modalContainer.classList.contains("hidden")) closeModal();
            if (!alertContainer.classList.contains("hidden")) hideAlert();
        }
        });
        modalContainer.addEventListener("click", (e) => {
        if (e.target === modalContainer) closeModal();
        });
        alertContainer.addEventListener("click", (e) => {
        if (e.target === alertContainer) hideAlert();
        });
        modalClose.addEventListener("click", closeModal);

        // === LOGIN ===
        document.getElementById("loginScreen").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("btnLogin").click();
        }
        });

        document.getElementById("btnLogin").addEventListener("click", async () => {
        const u = (document.getElementById("userInput").value || "").trim();
        const p = document.getElementById("passInput").value || "";
        if (!u) return showAlert("Masukkan username kata Ruslan Kasep!", "error");
        if (p !== "fenisayangruslan")
            return showAlert("Password salah minta ke Ruslan Kasep!", "error");

        try {
            const res = await fetch(API_URL + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Login gagal");
            localStorage.setItem("loggedIn", "true");
            localStorage.setItem("username", data.user.username);
            localStorage.setItem("role", data.user.role);
            showApp();
        } catch (e) {
            showAlert(e.message, "error");
        }
        });

        document.getElementById("btnLogout").addEventListener("click", () => {
        localStorage.clear();
        location.reload();
        });
        if (localStorage.getItem("loggedIn")) showApp();

        // === THEME AUTO BY TIME ===
        function applyThemeByTime() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 18) {
            document.documentElement.classList.remove("dark");
        } else {
            document.documentElement.classList.add("dark");
        }
        }
        applyThemeByTime();

        // === HELPERS ===
        function fmtRp(num) {
        return "Rp " + Number(num).toLocaleString("id-ID");
        }
        function escapeHtml(s) {
        return String(s || "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;");
        }

        function showApp() {
            loginScreen.classList.add("hidden");
            app.classList.remove("hidden");
            loadUsersIfAdmin();
            importIfNeeded().then(fetchAndRender);
        }

        // === IMPORT VIA URL PARAM ===
        async function importIfNeeded() {
        const params = new URLSearchParams(window.location.search);
        const data = params.get("import");
        if (!data) return;
        try {
            const decoded = JSON.parse(decodeURIComponent(data));
            if (!Array.isArray(decoded)) return;

            await Promise.all(
            decoded.map((item) =>
                fetch(ITEMS_ENDPOINT, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-username": localStorage.getItem("username") || "imported",
                },
                body: JSON.stringify(item),
                })
            )
            );
            showAlert("‚úÖ Data berhasil diimport!", "success");
            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (err) {
            console.error("Import error:", err);
        }
        }

        let currentPage = 1;
        const limit = 10;

        // === Fetch with filters ===
        async function fetchAndRender() {
        loadingOverlay.classList.remove("hidden");

        const params = new URLSearchParams();
        params.append("page", currentPage);
        params.append("limit", limit);

        const keyword = document.getElementById("searchInput").value.trim();
        if (keyword) params.append("search", keyword);

        const sortVal = document.getElementById("sortSelect").value;
        if (sortVal === "date_desc") {
            params.append("sort", "tanggal");
            params.append("order", "desc");
        }
        if (sortVal === "date_asc") {
            params.append("sort", "tanggal");
            params.append("order", "asc");
        }
        if (sortVal === "nominal_desc") {
            params.append("sort", "nominal");
            params.append("order", "desc");
        }
        if (sortVal === "nominal_asc") {
            params.append("sort", "nominal");
            params.append("order", "asc");
        }

        const rangeVal = document.getElementById("filterRange").value;
        if (rangeVal !== "all") params.append("range", rangeVal);

        const listReq = fetch(ITEMS_ENDPOINT + "?" + params.toString(), {
            headers: { "x-username": localStorage.getItem("username") },
        });

        const allReq = fetchAllForSummary();

        const res = await listReq;
        if (res.status === 401) return location.reload();
        const { data: items, total } = await res.json();

        const all = await allReq;
        let inc = 0,
            exp = 0;
        all.forEach((i) => {
            const n = Number(i.nominal) || 0;
            if (n > 0) inc += n;
            else exp += n;
        });
        document.getElementById("totalIncome").textContent = fmtRp(inc);
        document.getElementById("totalExpense").textContent = fmtRp(Math.abs(exp));
        document.getElementById("totalBalance").textContent = fmtRp(inc + exp);

        render(items);
        renderPagination(total);

        loadingOverlay.classList.add("hidden");
        }

        // === Ambil semua data terfilter (tanpa pagination) ===
        async function fetchAllForSummary() {
        const params = new URLSearchParams();

        const keyword = document.getElementById("searchInput").value.trim();
        if (keyword) params.append("search", keyword);

        const sortVal = document.getElementById("sortSelect").value;
        if (sortVal === "date_desc") {
            params.append("sort", "tanggal");
            params.append("order", "desc");
        }
        if (sortVal === "date_asc") {
            params.append("sort", "tanggal");
            params.append("order", "asc");
        }
        if (sortVal === "nominal_desc") {
            params.append("sort", "nominal");
            params.append("order", "desc");
        }
        if (sortVal === "nominal_asc") {
            params.append("sort", "nominal");
            params.append("order", "asc");
        }

        const rangeVal = document.getElementById("filterRange").value;
        if (rangeVal !== "all") params.append("range", rangeVal);

        params.append("page", 1);
        params.append("limit", 100000);

        const res = await fetch(ITEMS_ENDPOINT + "?" + params.toString(), {
            headers: { "x-username": localStorage.getItem("username") },
        });
        const { data: all } = await res.json();
        return all || [];
        }

        // === Render Pagination ===
        function renderPagination(totalItems) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        const totalPages = Math.ceil(totalItems / limit);
        if (totalPages <= 1) return;

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Prev";
        prevBtn.disabled = currentPage === 1;
        prevBtn.className = `px-3 py-1 rounded ${
            prevBtn.disabled
            ? "bg-gray-300 dark:bg-gray-600"
            : "bg-blue-500 text-white hover:bg-blue-600"
        }`;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
            currentPage--;
            fetchAndRender();
            }
        };
        pagination.appendChild(prevBtn);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.textContent = i;
            btn.className =
            "px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300";
            if (i === currentPage) btn.classList.add("active");
            btn.onclick = () => {
            currentPage = i;
            fetchAndRender();
            };
            pagination.appendChild(btn);
        }

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.className = `px-3 py-1 rounded ${
            nextBtn.disabled
            ? "bg-gray-300 dark:bg-gray-600"
            : "bg-blue-500 text-white hover:bg-blue-600"
        }`;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
            currentPage++;
            fetchAndRender();
            }
        };
        pagination.appendChild(nextBtn);
        }

        // === Debounce Search ===
        function debounce(fn, delay = 500) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
        };
        }
        const debouncedSearch = debounce(() => {
        currentPage = 1;
        fetchAndRender();
        });
        document.getElementById("searchInput").addEventListener("input", debouncedSearch);

        // === Listener filter range & sort ===
        document.getElementById("filterRange").addEventListener("change", () => {
        currentPage = 1;
        fetchAndRender();
        });
        document.getElementById("sortSelect").addEventListener("change", () => {
        currentPage = 1;
        fetchAndRender();
        });

        // === RESET FILTER ===
        document.getElementById("btnReset").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("sortSelect").value = "date_desc";
        document.getElementById("filterRange").value = "all";
        currentPage = 1;
        fetchAndRender();
        });

        // === RENDER DATA ===
        function render(items) {
            lastItemsCache = items || [];
            itemsById.clear();
            lastItemsCache.forEach((it) => itemsById.set(String(it.id || it._id), it));

            const isAdmin = localStorage.getItem("role") === "admin";
            const thead = document.getElementById("tableHead");
            const tbody = document.getElementById("tableBody");
            const card = document.getElementById("cardList");

            // === Header table ===
            thead.innerHTML = `
                <tr>
                ${isAdmin ? `<th class="p-3 text-left">Nama</th>` : ""}
                <th class="p-3 text-left">Nominal</th>
                <th class="p-3 text-left">Keterangan</th>
                <th class="p-3 text-left">Tanggal</th>
                <th class="p-3 text-center">Bukti</th>
                <th class="p-3 text-center">Aksi</th>
                </tr>
            `;

            tbody.innerHTML = "";
            card.innerHTML = "";

            lastItemsCache.forEach((it) => {
                const itemId = it.id || it._id;

                // === Desktop Table Row ===
                tbody.innerHTML += `
                <tr class="border-b">
                    ${isAdmin ? `<td class="p-2 font-medium">${escapeHtml(it.user || "-")}</td>` : ""}
                    <td class="p-2 ${it.nominal >= 0 ? "text-green-600" : "text-red-600"}">${fmtRp(it.nominal)}</td>
                    <td class="p-2">${escapeHtml(it.keterangan || "-")}</td>
                    <td class="p-2">${escapeHtml(it.tanggal || "-")}</td>
                    <td class="p-2 text-center">
                    ${
                        it.photoUrl
                        ? `<button onclick="openDetail('${itemId}')" class="text-blue-500 underline cursor-pointer">Lihat</button>`
                        : "-"
                    }
                    </td>
                    <td class="p-2 text-center">
                    <button onclick="confirmDelete('${itemId}')" class="text-red-600">Hapus</button>
                    </td>
                </tr>
                `;

                // === Mobile Card ===
                card.innerHTML += `
                <div class="bg-gray-700 p-4 rounded-lg shadow">
                    <div class="flex justify-between">
                    <span>${escapeHtml(it.tanggal || "-")}</span>
                    <span class="${it.nominal >= 0 ? "text-green-400" : "text-red-400"} font-bold">${fmtRp(it.nominal)}</span>
                    </div>
                    <p class="text-sm mt-2">${escapeHtml(it.keterangan || "-")}</p>
                    ${isAdmin ? `<p class="text-xs text-gray-300 mt-1">User: ${escapeHtml(it.user || "-")}</p>` : ""}
                    <div class="flex justify-between mt-3 text-sm">
                    ${
                        it.photoUrl
                        ? `<button onclick="openDetail('${itemId}')" class="text-blue-400 underline">Bukti</button>`
                        : "-"
                    }
                    <button onclick="confirmDelete('${itemId}')" class="text-red-500">Hapus</button>
                    </div>
                </div>
                `;
            });
        }

        // === DETAIL TRANSAKSI ===
        function openDetail(id) {
        const key = String(id);
        const item =
            itemsById.get(key) ||
            lastItemsCache.find((x) => String(x.id || x._id) === key);

        if (!item) {
            showAlert("‚ùå Data tidak ditemukan di halaman ini.", "error");
            return;
        }

        let html = `
            <h2 class="text-lg font-bold mb-4">Detail Transaksi</h2>
            <p><b>Nama:</b> ${escapeHtml(item.user || item.nama || "-")}</p>
            <p><b>Nominal:</b> ${fmtRp(item.nominal)}</p>
            <p><b>Keterangan:</b> ${escapeHtml(item.keterangan || "-")}</p>
            <p><b>Tanggal:</b> ${escapeHtml(item.tanggal || "-")}</p>
        `;

        if (item.photoUrl) {
            html += `<div class="mt-4 text-center">
                <a href="${item.photoUrl}" target="_blank">
                    <img src="${item.photoUrl}" alt="Bukti" class="max-h-80 mx-auto rounded-lg shadow cursor-pointer hover:opacity-90">
                </a>
                <p class="text-sm text-blue-500 mt-2"><a href="${item.photoUrl}" target="_blank">Buka gambar asli</a></p>
            </div>`;
        } else {
            html += `<p class="mt-3 text-sm text-gray-500">Tidak ada bukti foto.</p>`;
        }

        showModal(html);
        }

        // === NOMINAL FORMAT INPUT ===
        const nominalInput = document.getElementById("fieldNominal");
        nominalInput.addEventListener("input", (e) => {
            let raw = e.target.value.replace(/[^\d-]/g, "");
            if (raw.startsWith("--")) raw = raw.replace(/^-+/, "-");
            if (!raw || raw === "-") {
            e.target.value = raw;
            return;
            }
            e.target.value = Number(raw).toLocaleString("id-ID");
        });

        // === ADMIN MODE: Ambil daftar user dan tampilkan dropdown ===
        async function loadUsersIfAdmin() {
            if (localStorage.getItem("role") !== "admin") return;
            const userSelectContainer = document.getElementById("userSelectContainer");
            const userSelect = document.getElementById("userSelect");
            userSelectContainer.classList.remove("hidden");

            try {
            const res = await fetch(API_URL + "/users", {
                headers: { "x-username": localStorage.getItem("username") },
            });
            const { data } = await res.json();
            userSelect.innerHTML = `<option value="">Pilih User</option>` + 
                data.map(u => `<option value="${u.username}">${u.username}</option>`).join("");
            } catch (e) {
            console.warn("Gagal load users, pakai list default.");
            }
        }

        // === FORM SUBMIT ===
        document.getElementById("itemForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const nominalRaw = nominalInput.value.replace(/\./g, "").replace(/,/g, "");
            const nominal = Number(nominalRaw);
            const keterangan = document.getElementById("fieldKeterangan").value.trim();
            const tanggal =
                document.getElementById("fieldTanggal").value ||
                new Date().toISOString().split("T")[0];
            const file = document.getElementById("fileInput").files[0];
            const statusEl = document.getElementById("uploadStatus");
            const userSelect = document.getElementById("userSelect");
            statusEl.textContent = "";
            if (!nominal) return showAlert("Nominal wajib di isi Ruslan Kasep Marahloh!", "error");

            // === Admin override user ===
            const isAdmin = localStorage.getItem("role") === "admin";
            const selectedUser = isAdmin && userSelect?.value ? userSelect.value : localStorage.getItem("username");
            const nama = selectedUser; // override nama

            let photoUrl = null, publicId = null;
            try {
                if (file) {
                statusEl.textContent = "Uploading...";
                const fd = new FormData();
                fd.append("file", file);
                const up = await fetch(UPLOAD_ENDPOINT, {
                    method: "POST",
                    headers: { "x-username": selectedUser },
                    body: fd,
                });
                const j = await up.json();
                if (!up.ok) throw new Error(j.error || "Upload gagal");
                photoUrl = j.link || null;
                publicId = j.id || null;
                statusEl.textContent = "Upload selesai";
                }

                const createRes = await fetch(ITEMS_ENDPOINT, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-username": selectedUser, // override username header
                },
                body: JSON.stringify({
                    nama,
                    nominal,
                    keterangan,
                    tanggal,
                    photoUrl,
                    publicId,
                }),
                });

                if (!createRes.ok) throw new Error(await createRes.text());
                document.getElementById("itemForm").reset();
                document.getElementById("fileInput").value = "";
                nominalInput.value = "";
                statusEl.textContent = "Transaksi tersimpan";
                setTimeout(() => (statusEl.textContent = ""), 2000);
                fetchAndRender();
            } catch (err) {
                showAlert("‚ùå " + err.message, "error");
                statusEl.textContent = "";
            }
            });

            // === DELETE ITEM ===
            function confirmDelete(id) {
            showAlertConfirm("Hapus transaksi ini?", async () => {
                await fetch(ITEMS_ENDPOINT + "/" + id, {
                method: "DELETE",
                headers: { "x-username": localStorage.getItem("username") },
                });
                fetchAndRender();
            });
        }

        // === EXPORT EXCEL ===
        document
        .getElementById("btnExportExcel")
        .addEventListener("click", async () => {
            if (typeof XLSX === "undefined")
            await loadScript(
                "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            );

            const res = await fetch(ITEMS_ENDPOINT, {
            headers: { "x-username": localStorage.getItem("username") },
            });
            const { data } = await res.json();
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transaksi");
            XLSX.writeFile(wb, "transaksi.xlsx");
        });

        // === LOAD SCRIPT ===
        function loadScript(src) {
        return new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
        });
        }
    </script>

  </body>
</html>
